{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jorda/Desktop/normalization/web/app/api/run-all/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { spawn } from \"child_process\";\r\nimport { writeFile, readFile, unlink, mkdir } from \"fs/promises\";\r\nimport { join } from \"path\";\r\nimport { randomUUID } from \"crypto\";\r\n\r\nexport async function POST(request) {\r\n  let inputPath;\r\n  let transposedPath;\r\n  let outputPath;\r\n\r\n  try {\r\n    const formData = await request.formData();\r\n    const file = formData.get(\"file\");\r\n    if (!file || !(file instanceof Blob)) {\r\n      return NextResponse.json(\r\n        { error: \"No file uploaded. Use form field 'file'.\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const startCell = (formData.get(\"startCell\") || \"B9\").toString().trim() || \"B9\";\r\n\r\n    const maxSecondsRaw = formData.get(\"maxSeconds\");\r\n    let maxSeconds = null;\r\n    if (maxSecondsRaw != null && maxSecondsRaw !== \"\") {\r\n      const parsed = parseFloat(String(maxSecondsRaw).trim());\r\n      if (!isNaN(parsed) && parsed > 0) maxSeconds = parsed;\r\n    }\r\n\r\n    const projectRoot = join(process.cwd(), \"..\");\r\n    const tmpDir = join(projectRoot, \"tmp\");\r\n    const id = randomUUID();\r\n    inputPath = join(tmpDir, `${id}_in.xlsx`);\r\n    transposedPath = join(tmpDir, `${id}_transposed.xlsx`);\r\n    outputPath = join(tmpDir, `${id}_out.xlsx`);\r\n\r\n    await mkdir(tmpDir, { recursive: true });\r\n    const buffer = Buffer.from(await file.arrayBuffer());\r\n    await writeFile(inputPath, buffer);\r\n\r\n    const run = (pyCmd, args) =>\r\n      new Promise((resolve, reject) => {\r\n        const proc = spawn(pyCmd, args, {\r\n          cwd: projectRoot,\r\n          stdio: [\"ignore\", \"pipe\", \"pipe\"],\r\n        });\r\n        let stderr = \"\";\r\n        proc.stderr?.on(\"data\", (d) => {\r\n          stderr += d.toString();\r\n        });\r\n        proc.on(\"close\", (code) => {\r\n          if (code !== 0)\r\n            reject(new Error(stderr || `Python exited with ${code}`));\r\n          else resolve();\r\n        });\r\n        proc.on(\"error\", (err) => reject(err));\r\n      });\r\n\r\n    const runPy = async (args) => {\r\n      try {\r\n        await run(\"python\", args);\r\n      } catch (err) {\r\n        if (\r\n          process.platform === \"win32\" &&\r\n          (err.code === \"ENOENT\" || err.message.includes(\"python\"))\r\n        ) {\r\n          await run(\"py\", args);\r\n        } else {\r\n          throw err;\r\n        }\r\n      }\r\n    };\r\n\r\n    const transposeScript = join(projectRoot, \"transpose_excel.py\");\r\n    const normalizeScript = join(projectRoot, \"normalize.py\");\r\n\r\n    await runPy([\r\n      transposeScript,\r\n      inputPath,\r\n      transposedPath,\r\n      \"--start-cell\",\r\n      startCell,\r\n    ]);\r\n\r\n    const normArgs = [normalizeScript, transposedPath, outputPath];\r\n    if (maxSeconds != null) {\r\n      normArgs.push(\"--max-seconds\", String(maxSeconds));\r\n    }\r\n    await runPy(normArgs);\r\n\r\n    const outBuffer = await readFile(outputPath);\r\n    const baseName = file.name ? String(file.name).replace(/\\.[^.]+$/, \"\") : \"file\";\r\n    const filename = `${baseName}_normalized.xlsx`;\r\n\r\n    await unlink(inputPath).catch(() => {});\r\n    await unlink(transposedPath).catch(() => {});\r\n    await unlink(outputPath).catch(() => {});\r\n\r\n    return new NextResponse(outBuffer, {\r\n      status: 200,\r\n      headers: {\r\n        \"Content-Type\":\r\n          \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\r\n        \"Content-Disposition\": `attachment; filename=\"${filename}\"`,\r\n      },\r\n    });\r\n  } catch (err) {\r\n    if (inputPath) await unlink(inputPath).catch(() => {});\r\n    if (transposedPath) await unlink(transposedPath).catch(() => {});\r\n    if (outputPath) await unlink(outputPath).catch(() => {});\r\n    console.error(err);\r\n    return NextResponse.json(\r\n      {\r\n        error:\r\n          err.message ||\r\n          \"Run all failed. Ensure Python and pandas/openpyxl are installed.\",\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}