{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/jorda/Desktop/normalization/web/app/api/transpose/route.js"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport { spawn } from \"child_process\";\r\nimport { writeFile, readFile, unlink, mkdir } from \"fs/promises\";\r\nimport { join } from \"path\";\r\nimport { randomUUID } from \"crypto\";\r\n\r\nexport async function POST(request) {\r\n  let inputPath;\r\n  let outputPath;\r\n\r\n  try {\r\n    const formData = await request.formData();\r\n    const file = formData.get(\"file\");\r\n    if (!file || !(file instanceof Blob)) {\r\n      return NextResponse.json(\r\n        { error: \"No file uploaded. Use form field 'file'.\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const startCell = (formData.get(\"startCell\") || \"A9\").toString().trim() || \"A9\";\r\n\r\n    const projectRoot = join(process.cwd(), \"..\");\r\n    const scriptPath = join(projectRoot, \"transpose_excel.py\");\r\n    const tmpDir = join(projectRoot, \"tmp\");\r\n    const id = randomUUID();\r\n    inputPath = join(tmpDir, `${id}_in.xlsx`);\r\n    outputPath = join(tmpDir, `${id}_out.xlsx`);\r\n\r\n    await mkdir(tmpDir, { recursive: true });\r\n    const buffer = Buffer.from(await file.arrayBuffer());\r\n    await writeFile(inputPath, buffer);\r\n\r\n    const args = [\r\n      scriptPath,\r\n      inputPath,\r\n      outputPath,\r\n      \"--start-cell\",\r\n      startCell,\r\n    ];\r\n\r\n    const run = (pyCmd) =>\r\n      new Promise((resolve, reject) => {\r\n        const proc = spawn(pyCmd, args, {\r\n          cwd: projectRoot,\r\n          stdio: [\"ignore\", \"pipe\", \"pipe\"],\r\n        });\r\n        let stderr = \"\";\r\n        proc.stderr?.on(\"data\", (d) => { stderr += d.toString(); });\r\n        proc.on(\"close\", (code) => {\r\n          if (code !== 0) reject(new Error(stderr || `Python exited with ${code}`));\r\n          else resolve();\r\n        });\r\n        proc.on(\"error\", (err) => reject(err));\r\n      });\r\n\r\n    try {\r\n      await run(\"python\");\r\n    } catch (err) {\r\n      if (process.platform === \"win32\" && (err.code === \"ENOENT\" || err.message.includes(\"python\"))) {\r\n        try {\r\n          await run(\"py\");\r\n        } catch (e2) {\r\n          throw new Error(\"Python not found. Install Python and add it to PATH (or use 'py' on Windows).\");\r\n        }\r\n      } else throw err;\r\n    }\r\n\r\n    const outBuffer = await readFile(outputPath);\r\n    const baseName = file.name ? String(file.name).replace(/\\.[^.]+$/, \"\") : \"file\";\r\n    const filename = `${baseName}_transposed.xlsx`;\r\n\r\n    await unlink(inputPath).catch(() => {});\r\n    await unlink(outputPath).catch(() => {});\r\n\r\n    return new NextResponse(outBuffer, {\r\n      status: 200,\r\n      headers: {\r\n        \"Content-Type\": \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\r\n        \"Content-Disposition\": `attachment; filename=\"${filename}\"`,\r\n      },\r\n    });\r\n  } catch (err) {\r\n    if (inputPath) await unlink(inputPath).catch(() => {});\r\n    if (outputPath) await unlink(outputPath).catch(() => {});\r\n    console.error(err);\r\n    return NextResponse.json(\r\n      { error: err.message || \"Transpose failed. Ensure Python and pandas/openpyxl are installed.\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,eAAe,KAAK,OAAO;IAChC,IAAI;IACJ,IAAI;IAEJ,IAAI;QACF,MAAM,WAAW,MAAM,QAAQ,QAAQ;QACvC,MAAM,OAAO,SAAS,GAAG,CAAC;QAC1B,IAAI,CAAC,QAAQ,CAAC,CAAC,gBAAgB,IAAI,GAAG;YACpC,OAAO,uJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA2C,GACpD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,YAAY,CAAC,SAAS,GAAG,CAAC,gBAAgB,IAAI,EAAE,QAAQ,GAAG,IAAI,MAAM;QAE3E,MAAM,cAAc,IAAA,yGAAI,EAAC,QAAQ,GAAG,IAAI;QACxC,MAAM,aAAa,IAAA,yGAAI,EAAC,aAAa;QACrC,MAAM,SAAS,IAAA,yGAAI,EAAC,aAAa;QACjC,MAAM,KAAK,IAAA,mHAAU;QACrB,YAAY,IAAA,yGAAI,EAAC,QAAQ,GAAG,GAAG,QAAQ,CAAC;QACxC,aAAa,IAAA,yGAAI,EAAC,QAAQ,GAAG,GAAG,SAAS,CAAC;QAE1C,MAAM,IAAA,8HAAK,EAAC,QAAQ;YAAE,WAAW;QAAK;QACtC,MAAM,SAAS,OAAO,IAAI,CAAC,MAAM,KAAK,WAAW;QACjD,MAAM,IAAA,kIAAS,EAAC,WAAW;QAE3B,MAAM,OAAO;YACX;YACA;YACA;YACA;YACA;SACD;QAED,MAAM,MAAM,CAAC,QACX,IAAI,QAAQ,CAAC,SAAS;gBACpB,MAAM,OAAO,IAAA,4HAAK,EAAC,OAAO,MAAM;oBAC9B,KAAK;oBACL,OAAO;wBAAC;wBAAU;wBAAQ;qBAAO;gBACnC;gBACA,IAAI,SAAS;gBACb,KAAK,MAAM,EAAE,GAAG,QAAQ,CAAC;oBAAQ,UAAU,EAAE,QAAQ;gBAAI;gBACzD,KAAK,EAAE,CAAC,SAAS,CAAC;oBAChB,IAAI,SAAS,GAAG,OAAO,IAAI,MAAM,UAAU,CAAC,mBAAmB,EAAE,MAAM;yBAClE;gBACP;gBACA,KAAK,EAAE,CAAC,SAAS,CAAC,MAAQ,OAAO;YACnC;QAEF,IAAI;YACF,MAAM,IAAI;QACZ,EAAE,OAAO,KAAK;YACZ,IAAI,QAAQ,QAAQ,KAAK,WAAW,CAAC,IAAI,IAAI,KAAK,YAAY,IAAI,OAAO,CAAC,QAAQ,CAAC,SAAS,GAAG;gBAC7F,IAAI;oBACF,MAAM,IAAI;gBACZ,EAAE,OAAO,IAAI;oBACX,MAAM,IAAI,MAAM;gBAClB;YACF,OAAO,MAAM;QACf;QAEA,MAAM,YAAY,MAAM,IAAA,iIAAQ,EAAC;QACjC,MAAM,WAAW,KAAK,IAAI,GAAG,OAAO,KAAK,IAAI,EAAE,OAAO,CAAC,YAAY,MAAM;QACzE,MAAM,WAAW,GAAG,SAAS,gBAAgB,CAAC;QAE9C,MAAM,IAAA,+HAAM,EAAC,WAAW,KAAK,CAAC,KAAO;QACrC,MAAM,IAAA,+HAAM,EAAC,YAAY,KAAK,CAAC,KAAO;QAEtC,OAAO,IAAI,uJAAY,CAAC,WAAW;YACjC,QAAQ;YACR,SAAS;gBACP,gBAAgB;gBAChB,uBAAuB,CAAC,sBAAsB,EAAE,SAAS,CAAC,CAAC;YAC7D;QACF;IACF,EAAE,OAAO,KAAK;QACZ,IAAI,WAAW,MAAM,IAAA,+HAAM,EAAC,WAAW,KAAK,CAAC,KAAO;QACpD,IAAI,YAAY,MAAM,IAAA,+HAAM,EAAC,YAAY,KAAK,CAAC,KAAO;QACtD,QAAQ,KAAK,CAAC;QACd,OAAO,uJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,IAAI,OAAO,IAAI;QAAqE,GAC7F;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}